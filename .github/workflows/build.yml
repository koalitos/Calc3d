name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ğŸ‰ Calc 3D Print ${{ github.ref_name }} - Release Inicial
          body: |
            # ğŸ‰ Calc 3D Print ${{ github.ref_name }} - Release Inicial
            
            Sistema completo para calcular custos e preÃ§os de venda de impressÃµes 3D.
            
            ## âœ¨ Destaques
            
            - ğŸ’° **CÃ¡lculo AutomÃ¡tico de Custos** - Filamento, energia, depreciaÃ§Ã£o, embalagem e taxas
            - ğŸ“Š **GestÃ£o Completa** - MÃ¡quinas, filamentos, projetos, vendas e despesas
            - ğŸ¯ **Upload de G-code** - ExtraÃ§Ã£o automÃ¡tica de peso e tempo de impressÃ£o
            - ğŸ’¾ **Backup Integrado** - Seus dados sempre seguros
            - ğŸ” **Sistema de Login** - MÃºltiplos usuÃ¡rios com autenticaÃ§Ã£o JWT
            - ğŸ¨ **Interface Moderna** - Design profissional com tema escuro
            - ğŸ”„ **Auto-updater** - AtualizaÃ§Ãµes automÃ¡ticas
            
            ## ğŸ“¥ InstalaÃ§Ã£o
            
            ### ğŸªŸ Windows
            Baixe e execute `Calc3DPrint-Setup-1.0.0.exe`
            
            ### ğŸ macOS
            - **Intel**: `Calc3DPrint-1.0.0-x64.dmg`
            - **Apple Silicon (M1/M2/M3)**: `Calc3DPrint-1.0.0-arm64.dmg`
            
            ### ğŸ§ Linux
            - **Universal**: `Calc3DPrint-1.0.0-x64.AppImage`
            - **Debian/Ubuntu**: `calc3dprint_1.0.0_amd64.deb`
            
            **Requisitos**: 4 GB RAM, 500 MB espaÃ§o
            
            ## ğŸš€ Novidades
            
            âœ… Interface moderna e intuitiva  
            âœ… Tela de loading animada  
            âœ… Ãcone personalizado (impressora 3D)  
            âœ… Backend integrado (sem instalaÃ§Ãµes extras)  
            âœ… Banco de dados SQLite local  
            âœ… Instaladores profissionais para todas as plataformas  
            âœ… Auto-updater (atualizaÃ§Ãµes automÃ¡ticas)  
            âœ… Suporte multiplataforma (Windows, macOS, Linux)  
            
            ## ğŸ› Reportar Bugs
            
            Encontrou um problema? [Abra uma issue](https://github.com/koalitos/calc3D/issues)
            
            ---
            
            **Desenvolvido com â¤ï¸ para a comunidade de impressÃ£o 3D**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install dependencies
        run: |
          npm install
          cd backend && npm install && cd ..
          cd frontend && npm install && cd ..
      
      - name: Build frontend
        run: npm run build
      
      - name: Build Windows installer
        run: npm run dist:win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.exe
          retention-days: 5
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install dependencies
        run: |
          npm install
          cd backend && npm install && cd ..
          cd frontend && npm install && cd ..
      
      - name: Build frontend
        run: npm run build
      
      - name: Build macOS DMG
        run: npm run dist:mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: List generated files
        run: ls -lah dist/
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            dist/*.dmg
          retention-days: 5
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install dependencies
        run: |
          npm install
          cd backend && npm install && cd ..
          cd frontend && npm install && cd ..
      
      - name: Build frontend
        run: npm run build
      
      - name: Build Linux packages
        run: npm run dist:linux
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.AppImage
            dist/*.deb
          retention-days: 5
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.AppImage
            dist/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
